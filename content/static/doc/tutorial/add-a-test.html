<!--{
    "Title": "Add a test",
    "Path":  "/doc/tutorial/add-a-test"
}-->

<p>
  现在你已经把代码放在了一个稳定的地方（顺便说一句，做得很好），可以增加一个测试了。
  在开发的过程中测试代码可以随时发现代码更改造成的bug。
  在本节你需要为 <code>Hello</code> 函数添加一个测试。
</p>

<aside class="Note">
  <strong>注意:</strong> 本主题是以 <a href="create-module.html">Create a Go module</a> 为开始的一系列主题的一部分。
</aside>

<p>
  Go对单元测试的内置支持使测试更容易进行。尤其是使用命名约定、Go的 <code>testing</code> 包以及 <code>go test</code> 命令，你可以快速编写和执行测试。
</p>

<ol>
  <li>
    在greetings目录, 创建greetings_test.go文件。

    <p>
      以 _test.go 结尾命名文件，告诉 <code>go test</code> 命令这个文件包含了测试函数。
    </p>
  </li>

  <li>
    在 greetings_test.go 中，粘贴以下代码并保存文件。

    <pre>
package greetings

import (
    "testing"
    "regexp"
)

// TestHelloName calls greetings.Hello with a name, checking 
// for a valid return value.
func TestHelloName(t *testing.T) {
    name := "Gladys"
    want := regexp.MustCompile(`\b`+name+`\b`)
    msg, err := Hello("Gladys")
    if !want.MatchString(msg) || err != nil {
        t.Fatalf(`Hello("Gladys") = %q, %v, want match for %#q, nil`, msg, err, want)
    }
}

// TestHelloEmpty calls greetings.Hello with an empty string, 
// checking for an error.
func TestHelloEmpty(t *testing.T) {
    msg, err := Hello("")
    if msg != "" || err == nil {
        t.Fatalf(`Hello("") = %q, %v, want "", error`, msg, err)
    }
}
</pre
    >

    <p>
      在以上代码中，你：
    </p>

    <ul>
      <li>
        在被测试代码的相同的包中，实现了测试函数。
      </li>
      <li>
        为 <code>greetings.Hello</code> 函数创建了两个测试函数。测试函数名的格式是 <code>Test<em>Name</em></code> ，
        其中 <em>Name</em> 是针对当前测试的。测试函数也包含了一个指向 <a href="https://golang.org/pkg/testing/"> <code>testing</code> 包</a>
        的指针参数。你可以在测试中使用这个参数的方法进行报告和记录。
      </li>
      <li>
        实现两个测试：

        <ul>
          <li>
            <code>TestHelloName</code> 调用 <code>Hello</code> 函数,
            传递了一个 <code>name</code> 值，这种情况该函数应该可以返回一个有效的响应消息。
            如果这个调用返回了一个 error 或者非预期的响应消息（没有包含你传递进去的 name）, 
            那么 <code>t</code> 参数的 <code>Fatalf</code> 方法向控制台打印消息并结束执行。
          </li>
          <li>
            <code>TestHelloEmpty</code> 使用空字符串调用 <code>Hello</code> 函数。
            这个测试用于验证你的错误处理能够正常工作。如果返回了一个非空的字符串或者一个 error，
            那么 <code>t</code> 参数的 <a href="https://golang.org/pkg/testing/#T.Fatalf"><code>Fatalf</code> 方法</a>
            向控制台打印消息并结束执行。
          </li>
        </ul>
      </li>
    </ul>
  </li>

  <li>
    在 greetings 目录打开命令行，运行 <a href="https://golang.org/cmd/go/#hdr-Test_packages"><code>go test</code> 命令</a>
    执行测试。

    <p>
      <code>go test</code> 命令执行测试文件（以 _test.go结尾的文件）中的测试函数（名字以 <code>Test</code> 开头的函数）。
      你可以添加 <code>-v</code> 标志，输出包含所有测试及对应结果的详细信息。
    </p>

    <p>
      测试应该能够通过。
    </p>

    <pre>
$ go test
PASS
ok      example.com/greetings   0.364s

$ go test -v
=== RUN   TestHelloName
--- PASS: TestHelloName (0.00s)
=== RUN   TestHelloEmpty
--- PASS: TestHelloEmpty (0.00s)
PASS
ok      example.com/greetings   0.372s
</pre
    >
  </li>

  <li>
    破坏 <code>greetings.Hello</code> 函数来看一个失败的测试。

    <p>
      <code>TestHelloName</code> 测试函数根据你给出的 <code>Hello</code> 函数的参数 name，检查对应的返回值。
      为了看到一个失败的测试结果，修改 <code>greetings.Hello</code> 函数，让它不再包含 name。
    </p>

    <p>
      在 greetings/greetings.go中，粘贴以下代码，替换 <code>Hello</code> 函数。
      注意高亮的两行修改了函数的返回值，如同 <code>name</code> 参数被意外删除了一样。
    </p>

    <pre>
// Hello returns a greeting for the named person.
func Hello(name string) (string, error) {
    // If no name was given, return an error with a message.
    if name == "" {
        return name, errors.New("empty name")
    }
    // Create a message using a random format.
    <ins>// message := fmt.Sprintf(randomFormat(), name)
    message := fmt.Sprint(randomFormat())</ins>
    return message, nil
}
</pre>
  </li>

  <li>
    在 greetings 目录打开命令行，运行 <code>go test</code> 执行测试。

    <p>
      这一次，不添加 <code>-v</code> 标志，运行 <code>go test</code> 。
      输出只会包含测试失败的结果，如果有很多测试的话，这样会很有用。
      <code>TestHelloName</code> 测试应该会失败， 但<code>TestHelloEmpty</code> 仍然可以通过。
    </p>

    <pre>
$ go test
--- FAIL: TestHelloName (0.00s)
    greetings_test.go:15: Hello("Gladys") = "Hail, %v! Well met!", &lt;nil>, want match for `\bGladys\b`, nil
FAIL
exit status 1
FAIL    example.com/greetings   0.182s
</pre
    >
  </li>
</ol>

<p>
  本节介绍了 Go 对单元测试的内置支持。
  在 <a href="compile-install.html">下一主题</a> 教程中，你将了解如何编译和安装代码，以便在本地运行。
</p>

<p class="Navigation">
  <a class="Navigation-prev" href="greetings-multiple-people.html"
    >&lt; 为多个人返回问候语 </a
  >
  <a class="Navigation-next" href="compile-install.html"
    >编译和安装应用 &gt;</a
  >
</p>
